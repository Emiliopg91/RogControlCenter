# Maintainer: Emiliopg91 <ojosdeserbio@gmail.com>
pkgname=rog-control-center
pkgver=<version>
pkgrel=1
pkgdesc="RogControlCenter - An utility to manage Asus Rog laptop performance and RGB lighting"
arch=('x86_64')
url="https://github.com/Emiliopg91/RogControlCenter"
license=('GPL2')
depends=(
  'asusctl'
  'fuse2'
  'hicolor-icon-theme'
  'libsecret'
  'power-profiles-daemon'
  'python'
  'python-pip'
  'qt6-base'
  'qt6-charts'
  'qt6-svg'
  'zlib'
)
makedepends=(
  'clang'
  'cmake'
  'git'
  'libsecret'
  'ninja'
  'podman'
  'podman-docker'
  'python'
  'qt6-base'
  'qt6-charts'
  'qt6-svg'
  'libsecret'
  'zlib'
  'unzip'
  'zip'
)
source=("git+https://github.com/Emiliopg91/RogControlCenter.git#tag=$pkgver")
sha256sums=('SKIP')

prepare() {
    if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
        echo "Installing nodejs and its packages"
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
        nvm install 24
        nvm use 24
        npm i -g pnpm@8.5.1 shx@0.3.4
    fi

    cd "$srcdir/RogControlCenter"
    git submodule update --init --recursive

    export CONTAINERS_STORAGE_CONF=$srcdir/containers-storage.conf
    cat > "$CONTAINERS_STORAGE_CONF" <<EOF
[storage]
driver = "vfs"
runroot = "/tmp/containers/runroot"
graphroot = "/tmp/containers/storage"
EOF
}

build() {
    cd "$srcdir/RogControlCenter"
    make config
    IN_PKGBUILD=1 make release
}

package() {
    cd "$srcdir/RogControlCenter/dist/appimage-fs"

    install -Dm755 usr/bin/RogControlCenter \
        "$pkgdir/usr/bin/rogcontrolcenter"

    install -d "$pkgdir/usr/share/rogcontrolcenter"
    cp -r usr/share/RogControlCenter/* \
        "$pkgdir/usr/share/rogcontrolcenter/"
    chmod 777 -R "$pkgdir/usr/share/rogcontrolcenter"

    install -d "$pkgdir/usr/share/applications"
    sed -e 's|Exec=usr/bin/RogControlCenter|Exec=/usr/bin/rogcontrolcenter|' \
        -e 's|Icon=icon|Icon=rogcontrolcenter|' \
        RogControlCenter.desktop > "$pkgdir/usr/share/applications/rogcontrolcenter.desktop"

    install -Dm644 icon.svg \
        "$pkgdir/usr/share/icons/hicolor/scalable/apps/rogcontrolcenter.svg"
}
