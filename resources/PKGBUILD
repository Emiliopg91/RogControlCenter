# Maintainer: Emiliopg91 <ojosdeserbio@gmail.com>
pkgname=rog-control-center
pkgver=<version>
pkgrel=1
pkgdesc="RogControlCenter - An utility to manage Asus Rog laptop performance and RGB lighting"
arch=('x86_64')
url="https://github.com/Emiliopg91/RogControlCenter"
license=('GPL2')
source=("git+https://github.com/Emiliopg91/RogControlCenter.git#tag=$pkgver")
sha256sums=('SKIP')
options=('!strip')
depends=(
  'asusctl'
  'coreutils'
  'fuse2'
  'hicolor-icon-theme'
  'hidapi'
  'libsecret'
  'libusb'
  'mbedtls'
  'power-profiles-daemon'
  'python'
  'python-pip'
  'qt5-base'
  'qt5-tools'
  'qt6-base'
  'qt6-charts'
  'qt6-svg'
  'scx-scheds'
  'upower'
)
makedepends=(
  'base-devel'
  'clang'
  'cmake'
  'git'
  'libsecret'
  'ninja'
  'npm'
  'pkgconf'
  'podman'
  'qtcreator'
  'unzip'
  'zip'
)

prepare() {

    if ! command -v pnpm &> /dev/null || ! command -v shx &> /dev/null; then
        echo "Installing missing npm modules"
        sudo npm i -g pnpm@8.5.1 shx@0.3.4
    fi

    cd "$srcdir/RogControlCenter"
    git submodule update --init --recursive

    export CONTAINERS_STORAGE_CONF=$srcdir/containers-storage.conf
    cat > "$CONTAINERS_STORAGE_CONF" <<EOF
[storage]
driver = "vfs"
runroot = "/tmp/containers/runroot"
graphroot = "/tmp/containers/storage"
EOF
}

build() {
    export APPIMAGE_EXTRACT_AND_RUN=1
    unset SOURCE_DATE_EPOCH

    case "$ARCH_LEVEL" in
        x86-64-v3) export CXXFLAGS="-march=x86-64-v3" ;;
        x86-64-v4) export CXXFLAGS="-march=x86-64-v4" ;;
        zen4)      export CXXFLAGS="-march=znver4" ;;
        native)    export CXXFLAGS="-march=native" ;;
        ""|default|*) export CXXFLAGS="" ;;  # Por defecto
    esac

    cd "$srcdir/RogControlCenter"
    IS_AURPKG=1 make release
}

package() {
    cd "$srcdir/RogControlCenter/dist/appimage-fs"

    install -Dm755 ../RogControlCenter.AppImage \
        "$pkgdir/usr/bin/rogcontrolcenter"

    install -d "$pkgdir/usr/share/applications"
    sed -e 's|Exec=usr/bin/RogControlCenter|Exec=/usr/bin/rogcontrolcenter|' \
        -e 's|Icon=icon|Icon=rogcontrolcenter|' \
        RogControlCenter.desktop > "$pkgdir/usr/share/applications/rogcontrolcenter.desktop"

    install -Dm644 icon.svg \
        "$pkgdir/usr/share/icons/hicolor/scalable/apps/rogcontrolcenter.svg"
}
